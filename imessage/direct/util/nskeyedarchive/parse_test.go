// beeper-imessage - A Matrix-iMessage puppeting bridge.
// Copyright (C) 2023 Beeper, Inc.
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU Affero General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU Affero General Public License for more details.
//
// You should have received a copy of the GNU Affero General Public License
// along with this program.  If not, see <https://www.gnu.org/licenses/>.

package nskeyedarchive_test

import (
	"encoding/base64"
	"testing"

	"github.com/stretchr/testify/assert"
	"howett.net/plist"

	"github.com/beeper/imessage/imessage/direct"
	"github.com/beeper/imessage/imessage/direct/util/gnuzip"
	"github.com/beeper/imessage/imessage/direct/util/nskeyedarchive"
)

func TestParse(t *testing.T) {
	raw := `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`

	body, err := base64.StdEncoding.DecodeString(raw)
	assert.NoError(t, err)
	body, err = gnuzip.MaybeGUnzip(body)
	assert.NoError(t, err)

	var balloonPayload direct.BalloonPayload
	_, err = plist.Unmarshal(body, &balloonPayload)
	assert.NoError(t, err)

	val, err := nskeyedarchive.Parse(balloonPayload.Payload)
	assert.NoError(t, err)
	valAsMap, ok := val.(map[string]any)
	assert.True(t, ok)

	richLinkMetadata, ok := valAsMap["richLinkMetadata"].(map[string]any)
	assert.True(t, ok)

	assert.Equal(t, "https://www.google.com/", richLinkMetadata["URL"].(map[string]any)["NS.relative"])
	assert.Equal(t, "image/x-icon", richLinkMetadata["icon"].(map[string]any)["MIMEType"])
	assert.Equal(t, "Google", richLinkMetadata["title"])
}
